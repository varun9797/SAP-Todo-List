# CI/CD Dockerfile for Backend with Strict Quality Checks
FROM node:20-alpine AS base

# Build arguments for controlling quality check behavior
ARG SKIP_TESTS=false
ARG SKIP_LINT=false
ARG SKIP_TYPE_CHECK=false
ARG FAIL_ON_WARNINGS=true

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install all dependencies
RUN npm ci

# Copy source code and configuration files
COPY . .

# ===== STRICT QUALITY CHECKS STAGE =====
FROM base AS ci-quality-checks

# Run type checking
RUN if [ "$SKIP_TYPE_CHECK" = "false" ]; then \
      echo "ðŸ” Running TypeScript type checking..." && \
      npm run type-check; \
    else \
      echo "â­ï¸ Skipping type checking"; \
    fi

# Run linting with strict mode
RUN if [ "$SKIP_LINT" = "false" ]; then \
      echo "ðŸ§¹ Running ESLint..." && \
      npm run lint; \
    else \
      echo "â­ï¸ Skipping linting"; \
    fi

# Run tests with coverage
RUN if [ "$SKIP_TESTS" = "false" ]; then \
      echo "ðŸ§ª Running tests with coverage..." && \
      npm run test:coverage; \
    else \
      echo "â­ï¸ Skipping tests"; \
    fi

# ===== BUILD STAGE =====
FROM base AS builder

# Build the application
RUN echo "ðŸ—ï¸ Building application..." && \
    npm run build

# ===== PRODUCTION STAGE =====
FROM node:20-alpine AS production

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install only production dependencies
RUN npm ci --only=production && npm cache clean --force

# Copy built application from builder stage
COPY --from=builder /app/dist ./dist

# Create non-root user
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# Change ownership of the app directory
RUN chown -R nodejs:nodejs /app
USER nodejs

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"

# Add labels for better image management
LABEL maintainer="SAP Todo List Team"
LABEL version="1.0.0"
LABEL description="SAP Todo List Backend API with CI/CD Quality Checks"

# Start the application
CMD ["npm", "start"]
